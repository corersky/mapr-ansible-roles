---
# tasks file for mapr-aws-bootstrap
  - name: install boto for ec2 module
    pip: name=boto state=present

  - name: create nodes for non-cluster roles
    action:
      module: ec2
      region: '{{ec2_region}}'
      zone: '{{ec2_zone}}'
      spot_price: '{{edge_node_price}}'
      key_name: '{{ec2_keypair}}'
      group: '{{ec2_security_group}}'
      image: '{{ec2_image}}' # This is a CentOS 6 image
      vpc_subnet_id: '{{vpc_subnet}}'
      assign_public_ip: true
      instance_type: '{{edge_node_type}}'
      count: '{{edge_node_count}}'
      wait: yes
      wait_timeout: '{{ec2_wait_timeout}}'
      volumes:
      - device_name: /dev/sda
        volume_size: 24
        delete_on_termination: true
      monitoring: yes
      instance_tags:
        Name: '{{ec2_name_tag}}'
    register: external

  - name: create some cluster nodes
    action:
      module: ec2
      region: '{{ec2_region}}'
      zone: '{{ec2_zone}}'
      spot_price: '{{cluster_node_price}}'
      key_name: '{{ec2_keypair}}'
      group: '{{ec2_security_group}}'
      image: '{{ec2_image}}' # This is a CentOS 6 image
      vpc_subnet_id: '{{vpc_subnet}}'
      assign_public_ip: true
      instance_type: '{{cluster_node_type}}'
      count: '{{cluster_node_count}}'
      wait: yes
      wait_timeout: '{{ec2_wait_timeout}}'
      volumes:
      - device_name: /dev/sda
        volume_size: 24
        delete_on_termination: true
      - device_name: /dev/sdb
        volume_size: 128
        delete_on_termination: true
      - device_name: /dev/sdc
        volume_size: 128
        delete_on_termination: true
      # - device_name: /dev/sdd
      #   volume_size: 64
      #   delete_on_termination: true
      # - device_name: /dev/sde
      #   volume_size: 64
      #   delete_on_termination: true
      monitoring: yes
      instance_tags:
        Name: '{{ec2_name_tag}}'
    register: ec2_cluster

  - name: write an inventory file containing the just-created cluster
    template: src=cluster.hosts.j2 dest='./cluster.hosts' mode=0644 backup=yes
