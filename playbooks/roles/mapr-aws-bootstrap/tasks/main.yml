---
# tasks file for mapr-aws-bootstrap
  - name: install boto for ec2 module
    pip: name=boto state=present

  - name: create nodes for edge/hivemeta/mysql roles
    action:
      module: ec2
      region: '{{ec2_region}}'
      zone: '{{ec2_zone}}'
      # spot_price: '{{edge_node_price}}'
      key_name: '{{ec2_keypair}}'
      group: '{{ec2_security_group}}'
      image: '{{ec2_image}}' # This is a CentOS 6 image
      vpc_subnet_id: '{{vpc_subnet}}'
      assign_public_ip: true
      instance_type: '{{edge_node_type}}'
      count: '{{edge_node_count}}'
      wait: yes
      wait_timeout: 500
      volumes:
      - device_name: /dev/sda
        volume_size: 24
        delete_on_termination: true
      monitoring: yes
      instance_tags:
        Name: '{{ec2_name_tag}}'
    register: external

  - name: create some cluster nodes
    action:
      module: ec2
      region: '{{ec2_region}}'
      zone: '{{ec2_zone}}'
      # spot_price: '{{cluster_node_price}}'
      key_name: '{{ec2_keypair}}'
      group: '{{ec2_security_group}}'
      image: '{{ec2_image}}' # This is a CentOS 6 image
      vpc_subnet_id: '{{vpc_subnet}}'
      assign_public_ip: true
      instance_type: '{{cluster_node_type}}'
      count: '{{cluster_node_count}}'
      wait: yes
      wait_timeout: 500
      volumes:
      - device_name: /dev/sda
        volume_size: 24
        delete_on_termination: true
      - device_name: /dev/sdb
        volume_size: 64
        delete_on_termination: true
      - device_name: /dev/sdc
        volume_size: 64
        delete_on_termination: true
      - device_name: /dev/sdd
        volume_size: 64
        delete_on_termination: true
      - device_name: /dev/sde
        volume_size: 64
        delete_on_termination: true
      monitoring: yes
      instance_tags:
        Name: '{{ec2_name_tag}}'
    register: ec2_cluster

  - name: tag an edge node
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: external.instances[0:1]
    args:
      tags:
        edge: true
    register: edge

  - name: tag a mysql node
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: external.instances[1:2]
    args:
      tags:
        mysql: true
    register: mysql

  - name: tag a hivemeta node
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: external.instances[2:3]
    args:
      tags:
        hiveserver: true
    register: hiveservers

  - name: tag three instances as zookeepers
    action: ec2_tag resource={{ item.id }} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances[0:3]
    args:
      tags:
        zookeeper: true
    register: zookeepers

  - name: tag two instances as CLDBs
    action: ec2_tag resource={{ item.id }} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances[0:2]
    args:
      tags:
        cldb: true
    register: cldbs

  - name: tag all instances as NFS servers
    action: ec2_tag resource={{ item.id }} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances
    args:
      tags:
        nfs: true
    register: nfs

  - name: tag two instances as webservers
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances[1:3]
    args:
      tags:
        webserver: true
    register: webservers

  - name: tag four instances with metrics
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances[1:5]
    args:
      tags:
        metrics: true
    register: metrics

  - name: tag all cluster nodes as fileservers
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances
    args:
      tags:
        fileserver: true
    register: fileservers

  - name: tag jobtrackers
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances[3:5]
    args:
      tags:
        jobtracker: true
    register: jobtrackers

  - name: tag tasktrackers
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances
    args:
      tags:
        tasktracker: true
    register: tasktrackers

  - name: tag hbase-masters
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances[3:5]
    args:
      tags:
        hbasemaster: true
    register: hbasemasters

  - name: tag hbase-regionservers
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances
    args:
      tags:
        hbaseregionserver: true
    register: hbaseregionservers

  - name: tag spark master
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances[0:1]
    args:
      tags:
        spark_master: true
    register: sparkmaster

  - name: tag spark slaves
    action: ec2_tag resource={{item.id}} region='{{ec2_region}}' state=present
    with_items: ec2_cluster.instances[1:5]
    args:
      tags:
        spark_slave: true
    register: sparkslaves

  - name: write an inventory file containing the just-created cluster
    template: src=cluster.hosts.j2 dest='./{{ec2_name_tag}}.hosts' mode=0644 backup=yes

  - name: remove cluster instances 
    action:
      module: ec2
      region: '{{ec2_region}}'
      state: absent
      instance_ids: '{{ec2_cluster.instance_ids}}'
    when: delete_immediately is defined

  - name: remove external instances 
    action:
      module: ec2
      region: '{{ec2_region}}'
      state: absent
      instance_ids: '{{external.instance_ids}}'
    when: delete_immediately is defined
